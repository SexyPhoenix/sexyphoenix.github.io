<!DOCTYPE HTML>
<html lang="en">

<head><meta name="generator" content="Hexo 3.9.0">
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="SexyPhoenix的博客">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <meta name="theme-version" content="1.2.3">
    <meta name="root" content="/">
    <link rel="dns-prefetch" href="https://sexyphoenix.github.io">
    <!--SEO-->

<meta name="keywords" content="PHP,Laravel,Vue,MySQL,Redis,Elasticsearch">


<meta name="description" content="背景
一次无意的访问，点击到了一个专门做PHP性能测试的网站，看这里PHP Benchmarks。
在里面发现了框架性能测试的结果，发现Laravel的框架性能尽然是最低的。瞬间受到了一万点的暴...">


<meta name="robots" content="all">
<meta name="google" content="all">
<meta name="googlebot" content="all">
<meta name="verify" content="all">
    <!--Title-->

<title>
    
     一次框架性能的比较，引起了我对搭建web框架的兴趣 |
    
    SexyPhoenix的博客
</title>


<link rel="icon" href="/favicon.ico">

    

<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.7.0">
<link rel="stylesheet" href="/css/style.css?rev=@@hash">
    
<div class="hide">
    <script type="text/javascript">
    var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
    document.write(unescape("%3Cspan class='cnzz_stat_icon_1263868967 hide' %3E%3Cscript%20src%3D%22https%3A%2F%2Fs95.cnzz.com%2Fz_stat.php%3Fweb_id%3D1272564536%22%3E%3C%2Fscript%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s19.cnzz.com/z_stat.php%3Fid%3D1263868967%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
    </script>
</div>




    

</head></html>
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->
<body>
    <header class="main-header"  style="background-image:url(
    https://raw.githubusercontent.com/SexyPhoenix/sexyphoenix.github.io/master/img/banner.jpg)"
     >
    <div class="main-header-box">
        <div class="branding">
            
            <h2>
                I do and I understand
            </h2>
            
        </div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                        <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="navbar-brand" href="https://sexyphoenix.github.io">
                        SexyPhoenix的博客</a>
                </div>
                <div class="collapse navbar-collapse" id="main-menu">
                    <ul class="menu">
                        
                        <li role="presentation" class="text-center">
                            <a href="/"><i class="fa "></i>
                                首页</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/架构/"><i class="fa "></i>
                                架构</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/PHP/"><i class="fa "></i>
                                PHP</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/Python/"><i class="fa "></i>
                                Python</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/Linux/"><i class="fa "></i>
                                Linux</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/前端/"><i class="fa "></i>
                                前端</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/数据库/"><i class="fa "></i>
                                数据库</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/网络/"><i class="fa "></i>
                                网络</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/安全/"><i class="fa "></i>
                                安全</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/其他/"><i class="fa "></i>
                                其他</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/about/"><i class="fa "></i>
                                关于我</a>
                        </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id=" 一次框架性能的比较，引起了我对搭建web框架的兴趣">
            
             一次框架性能的比较，引起了我对搭建web框架的兴趣
            
        </h1>
        <div class="post-meta">
    
    <span class="categories-meta fa-wrap">
        <i class="fa fa-folder-open-o"></i>
        <a class="category-link" href="/categories/架构/">架构</a>
    </span>
    
    
    <span class="fa-wrap">
        <i class="fa fa-tags"></i>
        <span class="tags-meta">
            
        </span>
    </span>
    
    
    
    <span class="fa-wrap">
        <i class="fa fa-clock-o"></i>
        <span class="date-meta">
            2019/12/17</span>
    </span>
    
    
</div>
        
        
    </div>
    
    <div class="post-body post-content">
        <h4 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h4><hr>
<p>一次无意的访问，点击到了一个专门做PHP性能测试的网站，看这里<a href="http://www.phpbenchmarks.com/en/" target="_blank" rel="noopener">PHP Benchmarks</a>。</p>
<p>在里面发现了框架性能测试的结果，发现Laravel的框架性能尽然是最低的。瞬间受到了一万点的暴击，谁让最近一直用Laravel开发项目的呢。</p>
<p>说到底还是Laravel好用呀，方便不说，各方面支持的也不错，业务方面做的也是内部系统，哪怕性能慢点，也可以用前后端分离、负载均衡等手段解决掉，大体上也是够用。</p>
<p>不过，作为一个开发人员，理想还是要有的，这时就在想能不能采取Laravel框架的优点，用到什么就装什么，去掉一些请求到响应之间用不到的组件，精简框架。</p>
<p>之前也熟读过Laravel的源码，知道它的底层用的是Symfony的组件，毕竟没必要重复的造轮子。那么我们的框架之旅也将基于Symfony组件。。。</p>
<h4 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h4><hr>
<p>一、Composer运行机制</p>
<p>二、框架前期准备</p>
<p>三、HttpFoundation组件封装Request、Response</p>
<p>四、路由处理</p>
<p>五、控制器处理相应功能（C）</p>
<p>六、分离模板（V）</p>
<p>七、分离模型（M）</p>
<p>八、剥离核心代码</p>
<p>九、优化框架</p>
<p>十、依赖注入（Dependency Injection）</p>
<h4 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h4><hr>
<h6 id="一、Composer运行机制"><a href="#一、Composer运行机制" class="headerlink" title="一、Composer运行机制"></a>一、Composer运行机制</h6><p>Composer的使用最关键的得益于<a href="https://www.php-fig.org/psr/" target="_blank" rel="noopener">PHP标准规范</a>的出现，特别是其中的psr4，<strong><em>自动加载规范</em></strong>，规范了如何指定文件路径从而自动加载类定义，以及自动加载文件的位置。</p>
<p>既然讲到php文件的加载，我们就要聊一聊PHP的加载机制了。</p>
<p>在早前时，加载文件用的都是include、require，但这种加载有很大的局限性，相信同学们都知道，无论用到用不到都要加载大量的文件，相当繁琐。</p>
<p>于是就出现了<strong><em>autoload加载机制</em></strong>，它可以实现懒加载。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">function __autoload($class)</span><br><span class="line">&#123;</span><br><span class="line">    require_once ($class.&quot;.php&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当程序引用了未加载的类，就会自动调用<strong>autoload方法，只要维护了</strong>autoload方法，就可以懒加载文件。</p>
<p>但这里有一个很大的问题，就是程序中只能定义一次<strong>autoload，这就需要花大尽力在</strong>autoload中维护文件和空间的对应关系，特别是在大型项目，多人合作中更是繁琐。</p>
<p>而解决这个问题就是<strong><em>SPL Autoload</em></strong>。</p>
<p>SPL Autoload：__autoload调用堆栈。</p>
<p>怎么理解这个堆栈呢，举个例子。</p>
<p>现有的框架比如ThinkPHP、Laravel等都有一个vendor目录，用于存放第三方库，现在vendor下有两个库。</p>
<blockquote>
<p>monolog 处理系统日志<br>guzzlehttp 处理HTTP</p>
</blockquote>
<p>当程序引用这两个库的命名空间，并调用monolog、guzzlehttp下面的类时，发现调用的类文件都能被找到。</p>
<p>这主要原理是<strong>monolog、guzzlehttp都自定义了类似autoload的方法，然后用spl_autoload_register将方法注册到了SPL堆栈中</strong>。</p>
<p>这样的话，当程序调用类的时候，就会统一到SPL堆栈中寻找注册到堆栈中的autoload方法，并加载相应的文件。</p>
<p>以上就是php加载文件的方式，下面就用实战谈一谈composer的运行机制。</p>
<p><strong>创建composer项目</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># mkdir phoenix</span><br><span class="line"># cd phoenix</span><br><span class="line">composer init</span><br></pre></td></tr></table></figure>

<p>phoenix是接下来搭建的框架名。</p>
<p><img src="https://raw.githubusercontent.com/SexyPhoenix/Blog/master/static/Phoenix/1.png" alt="1"></p>
<p>创建成功后，发现当前文件夹下会生成一个composer.json文件，里面是刚写入的内容。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer dump</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/SexyPhoenix/Blog/master/static/Phoenix/2.png" alt="2"></p>
<p>tree后，就会发现多了一个vendor的目录，里面的autoload.php以及composer文件夹下文件就是<strong>整个框架的加载核心</strong>。</p>
<p>接下来看一遍这些文件。</p>
<p>在整个框架中，第一行必然要引用 vendor/autoload.php 文件，毕竟这是加载核心，那么就从autoload.php看起。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># autoload.php</span><br><span class="line">require_once __DIR__ . &apos;/composer/autoload_real.php&apos;;</span><br><span class="line"></span><br><span class="line">return ComposerAutoloaderInit599fa618dd1395bdde5fc3a08ff3e4e6::getLoader();</span><br></pre></td></tr></table></figure>

<p>只调用了autoload_real.php里面的getLoader()方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#autoload_real.php 精简后的代码</span><br><span class="line"></span><br><span class="line">public static function loadClassLoader($class)</span><br><span class="line">&#123;</span><br><span class="line">    if (&apos;Composer\Autoload\ClassLoader&apos; === $class) &#123;</span><br><span class="line">        require __DIR__ . &apos;/ClassLoader.php&apos;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public static function getLoader()</span><br><span class="line">&#123;</span><br><span class="line">    #创建ClassLoader类</span><br><span class="line">    spl_autoload_register(array(&apos;ComposerAutoloaderInit599fa618dd1395bdde5fc3a08ff3e4e6&apos;, &apos;loadClassLoader&apos;), true, true);</span><br><span class="line"></span><br><span class="line">    #初始化ClassLoader对象（主要就是将命名空间和文件的映射写入ClassLoader的属性中）</span><br><span class="line">    self::$loader = $loader = new \Composer\Autoload\ClassLoader();</span><br><span class="line"></span><br><span class="line">    spl_autoload_unregister(array(&apos;ComposerAutoloaderInit599fa618dd1395bdde5fc3a08ff3e4e6&apos;, &apos;loadClassLoader&apos;)); </span><br><span class="line">     </span><br><span class="line">    #loadClass方法（类似autoload方法）注册到 SPL Autoload</span><br><span class="line">    $loader-&gt;register(true);   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>autoload_real.php 的作用就是引入ClassLoader类、初始化ClassLoader类，并注册到SPL堆栈中。</p>
<p>ClassLoader类中有很多属性，这些属性的作用也很简单：<strong>主要就是方便后面程序快速的通过命名空间找到它所映射的类文件</strong>。</p>
<p>具体用到这些属性的方法就在ClassLoader类中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># ClassLoader.php</span><br><span class="line"># 一个快速找到文件的算法，很有意思，感兴趣的可以研究下</span><br><span class="line"># 主要通过首字符找到命名空间以及长度，再根据命名空间以及长度找到文件</span><br><span class="line"></span><br><span class="line">private function findFileWithExtension($class, $ext)</span><br><span class="line">&#123;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么ClassLoader类属性里面的值是什么时候写入的呢？</p>
<p>答案很简单：<strong>当为项目安装组件时，即composer require xxx时，会更新ClassLoader类的属性值，也就是将命名空间和文件地址做一个关联</strong>。</p>
<p>接下来看看它的register方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># ClassLoader.php </span><br><span class="line">public function register($prepend = false)</span><br><span class="line">&#123;</span><br><span class="line">    spl_autoload_register(array($this, &apos;loadClass&apos;), true, $prepend);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看，其实很简单，就是将loadClass注册到SPL堆栈中。</p>
<p>那么现在就很清楚了，当程序使用了一个还未加载的类时，会调用什么方法？</p>
<p><strong>当然是loadClass方法</strong>，再来看看loadClass方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># ClassLoader.php </span><br><span class="line">public function loadClass($class)</span><br><span class="line">&#123;</span><br><span class="line">    if ($file = $this-&gt;findFile($class)) &#123;</span><br><span class="line">        includeFile($file);</span><br><span class="line"></span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据方法的名称就能看出它的功能：1、找到文件 2、加载文件。</p>
<p>总结一下Composer的运行机制：</p>
<p>*<em>1、在composer require安装时，更新ClassLoader类的属性 *</em>。</p>
<p><strong>2、运行对象时（new \Test()），如果未加载就会执行loadClass()，通过首字符找到命名空间以及长度，再根据命名空间以及长度找到文件，最后include文件</strong>。</p>
<p>以上就是Composer的运行机制，接下来，就进入真正的框架搭建了。</p>
<h6 id="二、框架前期准备"><a href="#二、框架前期准备" class="headerlink" title="二、框架前期准备"></a>二、框架前期准备</h6><p>在正式进入搭建框架之前，先看下整体的架构图以及一些前期准备。</p>
<p><img src="https://raw.githubusercontent.com/SexyPhoenix/Blog/master/static/Phoenix/3.png" alt="3"></p>
<p>整个架构跟Laravel、ThinkPHP等框架是差不多的，<strong>一次请求，一次返回，一个入口，中间根据路由规则交给相应的控制器去执行，在控制器中处理数据以及视图</strong>。</p>
<p>接下来做一些前期准备，进入phoenix项目。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># vi index.php 一个入口</span><br><span class="line">ini_set(&apos;display_errors&apos;, 1); # 显示错误</span><br><span class="line">error_reporting(-1);</span><br><span class="line"></span><br><span class="line">require_once __DIR__.&apos;/vendor/autoload.php&apos;; # 引入核心加载类</span><br><span class="line"></span><br><span class="line">$name = $_GET[&apos;name&apos;];</span><br><span class="line">dump($name);</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># dump()</span><br><span class="line">composer require symfony/var-dumper  # 类似var_dump，输出的变量体验更好些。</span><br></pre></td></tr></table></figure>

<p>配置Nginx，访问域名为：<a href="http://dev.phoenix.goods/?name=SexyPhoenix，" target="_blank" rel="noopener">http://dev.phoenix.goods/?name=SexyPhoenix，</a> 可以正常显示SexyPhoenix。</p>
<h6 id="三、HttpFoundation组件封装Request、Response"><a href="#三、HttpFoundation组件封装Request、Response" class="headerlink" title="三、HttpFoundation组件封装Request、Response"></a>三、HttpFoundation组件封装Request、Response</h6><p>现有的程序只是一个面向过程的代码，一个简单的请求，响应。</p>
<p>对于搭建web框架，这种痛苦写法当然是要被舍弃的，OOP编程才是正路。</p>
<p>既然要面向对象编程，首先要做的就是对流程中的Request、Response进行封装。而Symfony中专门的组件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer require symfony/http-foundation</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a href="http://www.symfonychina.com/doc/current/components/http_foundation.html" target="_blank" rel="noopener">HttpFoundation组件使用说明</a></p>
</blockquote>
<p>改造代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># index.php</span><br><span class="line"></span><br><span class="line">ini_set(&apos;display_errors&apos;, 1);</span><br><span class="line">error_reporting(-1);</span><br><span class="line"></span><br><span class="line">require_once __DIR__.&apos;/vendor/autoload.php&apos;;</span><br><span class="line"></span><br><span class="line">use Symfony\Component\HttpFoundation\Request;</span><br><span class="line">use Symfony\Component\HttpFoundation\Response;</span><br><span class="line"></span><br><span class="line">$request = Request::createFromGlobals(); # 创建request对象</span><br><span class="line"></span><br><span class="line">$name = $request-&gt;get(&apos;name&apos;, &apos;World&apos;); # 获取参数，可移入控制器或从模型得到数据</span><br><span class="line"></span><br><span class="line">$response = new Response();</span><br><span class="line"></span><br><span class="line">$response-&gt;setContent(&apos;&lt;b&gt;Hello &apos;.$name.&apos;&lt;/b&gt;&apos;); # 设置内容，可用view处理</span><br><span class="line"></span><br><span class="line">$response-&gt;send(); # 返回</span><br></pre></td></tr></table></figure>

<p>下面来做一个简单的分析。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$request = Request::createFromGlobals();</span><br></pre></td></tr></table></figure>

<p>这一行代码，是相当重要的，它从对象层面上处理了php的全局变量，例如 GET，POST，SESSION……。</p>
<p><img src="https://raw.githubusercontent.com/SexyPhoenix/Blog/master/static/Phoenix/4.png" alt="4"></p>
<p>这样处理就可以轻易的从request对象中获取所需要的信息以及对请求头等信息的修改。</p>
<p>后期路由这些附加的信息也是存在request的attributes属性中，及其好用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$response = new Response();</span><br></pre></td></tr></table></figure>

<p>通过response对象，可以轻易的控制返回的信息。比如头信息的各种缓存策略……</p>
<h6 id="四、路由处理"><a href="#四、路由处理" class="headerlink" title="四、路由处理"></a>四、路由处理</h6><p>从架构图上看，接着就要处理路由了。</p>
<p>phoneix框架用了普遍的做法，统一index.php入口。</p>
<p>那么下面要做的就是如何将路由的附加参数和要处理的控制器进行映射。</p>
<p>对于路由一般框架都是通过配置来的，这里也一样做成可配置，方便。</p>
<p><strong>Yaml格式配置路由</strong></p>
<p>在phoenix项目下，创建routes文件夹，在routes下继续创建web.yaml文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dashboard:</span><br><span class="line">    path: /dashboard</span><br><span class="line">    defaults: &#123; </span><br><span class="line">        _controller: &apos;App\Http\Controllers\DashboardController::index&apos;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>下载symfony的Config组件、Yaml组件、Routing组件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">composer require symfony/config</span><br><span class="line">composer require symfony/yaml</span><br><span class="line">composer require symfony/routing</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a href="http://www.symfonychina.com/doc/current/components/config.html" target="_blank" rel="noopener">Config组件使用说明</a></p>
</blockquote>
<p>更新代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># index.php</span><br><span class="line">ini_set(&apos;display_errors&apos;, 1);</span><br><span class="line">error_reporting(-1);</span><br><span class="line"></span><br><span class="line">require_once __DIR__.&apos;/vendor/autoload.php&apos;;</span><br><span class="line"></span><br><span class="line">use Symfony\Component\HttpFoundation\Request;</span><br><span class="line">use Symfony\Component\HttpFoundation\Response;</span><br><span class="line">use Symfony\Component\Routing\Loader\YamlFileLoader; # add </span><br><span class="line">use Symfony\Component\Config\FileLocator; # add</span><br><span class="line"></span><br><span class="line">$request = Request::createFromGlobals();</span><br><span class="line"></span><br><span class="line">$fileLoader = new YamlFileLoader(new FileLocator(array(__DIR__))); # add</span><br><span class="line">$collection = $fileLoader-&gt;load(&apos;routes/web.yaml&apos;); # add</span><br><span class="line"></span><br><span class="line">$name = $request-&gt;get(&apos;name&apos;, &apos;World&apos;);</span><br><span class="line"></span><br><span class="line">$response = new Response();</span><br><span class="line"></span><br><span class="line">$response-&gt;setContent(&apos;&lt;b&gt;Hello &apos;.$name.&apos;&lt;/b&gt;&apos;);</span><br><span class="line"></span><br><span class="line">$response-&gt;send();</span><br></pre></td></tr></table></figure>

<p>dump($collection)，可以看到返回了路由的Collection对象，里面有定义的路由。</p>
<p><img src="https://img2018.cnblogs.com/blog/423266/201912/423266-20191216173526032-1113725550.png" alt="5"></p>
<p>这个时候，框架只是得到了定义的路由，但还没有和URL做映射，下面改造继续。</p>
<p><strong>URL和配置路由映射</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">ini_set(&apos;display_errors&apos;, 1);</span><br><span class="line">error_reporting(-1);</span><br><span class="line"></span><br><span class="line">require_once __DIR__.&apos;/vendor/autoload.php&apos;;</span><br><span class="line"></span><br><span class="line">use Symfony\Component\HttpFoundation\Request;</span><br><span class="line">use Symfony\Component\HttpFoundation\Response;</span><br><span class="line">use Symfony\Component\Routing\Loader\YamlFileLoader;</span><br><span class="line">use Symfony\Component\Config\FileLocator;</span><br><span class="line">use Symfony\Component\Routing\RequestContext; # add</span><br><span class="line">use Symfony\Component\Routing\Matcher\UrlMatcher; # add</span><br><span class="line"></span><br><span class="line">$request = Request::createFromGlobals();</span><br><span class="line"></span><br><span class="line">$fileLoader = new YamlFileLoader(new FileLocator(array(__DIR__)));</span><br><span class="line">$collection = $fileLoader-&gt;load(&apos;routes/web.yaml&apos;);</span><br><span class="line"></span><br><span class="line">#解析url</span><br><span class="line">$context = new RequestContext(); # add </span><br><span class="line">$context-&gt;fromRequest($request); # add</span><br><span class="line"></span><br><span class="line">#初始化UrlMatcher</span><br><span class="line">$matcher    = new UrlMatcher($collection, $context); # add</span><br><span class="line"></span><br><span class="line">#url和路由配置映射</span><br><span class="line">$route = $matcher-&gt;match($request-&gt;getPathInfo()) # add</span><br><span class="line"></span><br><span class="line">$name = $request-&gt;get(&apos;name&apos;, &apos;World&apos;);</span><br><span class="line"></span><br><span class="line">$response = new Response();</span><br><span class="line"></span><br><span class="line">$response-&gt;setContent(&apos;&lt;b&gt;Hello &apos;.$name.&apos;&lt;/b&gt;&apos;);</span><br><span class="line"></span><br><span class="line">$response-&gt;send();</span><br></pre></td></tr></table></figure>

<p>继续分析。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$context = new RequestContext();</span><br><span class="line">$context-&gt;fromRequest($request);</span><br></pre></td></tr></table></figure>

<p>context对象主要就是对url进行解析。现在的域名：<a href="http://dev.phoenix.goods/dashboard" target="_blank" rel="noopener">http://dev.phoenix.goods/dashboard</a></p>
<p><img src="https://img2018.cnblogs.com/blog/423266/201912/423266-20191216172105588-728636732.png" alt="6"></p>
<p>既然解析出url的参数，就要用解析出的参数和配置中的路由做精准关联了，初始化matcher，传入路由配置和url对象。</p>
<p><img src="https://img2018.cnblogs.com/blog/423266/201912/423266-20191216172356617-467806567.png" alt="7"></p>
<p>得到url和配置中的路由的映射。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$route = $matcher-&gt;match($request-&gt;getPathInfo());</span><br></pre></td></tr></table></figure>

<p><img src="https://img2018.cnblogs.com/blog/423266/201912/423266-20191216173144227-1036602336.png" alt="8"></p>
<h6 id="五、控制器处理相应功能（C）"><a href="#五、控制器处理相应功能（C）" class="headerlink" title="五、控制器处理相应功能（C）"></a>五、控制器处理相应功能（C）</h6><p>在路由处理中，框架已经得到了路由和控制器的关联关系。下面就要执行相应的控制器（上面的_controller值）。</p>
<p>首先，在phoenix项目下，创建app/Http/Controllers/DashboardController.php（仿造Laravel的目录结构）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># DashboardController.php</span><br><span class="line">namespace App\Http\Controllers; # 注意这里App命名空间，自己定义，并没有注册到autoload</span><br><span class="line"></span><br><span class="line">class DashboardController&#123;</span><br><span class="line"></span><br><span class="line">    public function index()</span><br><span class="line">    &#123;</span><br><span class="line">        echo &apos;Hello SexyPhoenix&apos;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>App命名空间是框架定义的，需要注册后，才能用，打开项目的composer.json文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># composer.json</span><br><span class="line"></span><br><span class="line">&quot;autoload&quot;: &#123;</span><br><span class="line">    &quot;psr-4&quot;: &#123;</span><br><span class="line">        &quot;App\\&quot;: &quot;app/&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer dump-autoload # 更新命名空间</span><br></pre></td></tr></table></figure>

<p>到这里，控制器的准备工作就做完了，接下来的问题就是如果利用得到的路由和控制器的映射关系去执行控制器，也就是下面的代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">App\Http\Controllers\DashboardController::index</span><br></pre></td></tr></table></figure>

<p>其实也很简单，就是用”::”分隔，得到两个值，一个是类名，一个是方法名，再用php的call_user_func去执行。</p>
<p>但自己去写可能过去粗暴，可用性低，在执行前，要先判断DashboardController类是否存在，index方法是否存在，index方法的权限，是否是公共方法，以及各种参数等等，</p>
<p>自己去写的话，会很麻烦，为了方便，继续用symfony的组件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer require symfony/http-kernel</span><br></pre></td></tr></table></figure>

<p>http-kernel组件，是框架的内核，很重要的组件，它提供了各种钩子，及其方便框架扩展，也提供了控制器及其参数的“解析器”（这里需要了解下<a href="https://www.php.net/manual/zh/book.reflection.php" target="_blank" rel="noopener">php的反射机制</a>）。</p>
<p>更新index.php代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># index.php</span><br><span class="line">......</span><br><span class="line">use Symfony\Component\HttpKernel\Controller\ControllerResolver; # add</span><br><span class="line">use Symfony\Component\HttpKernel\Controller\ArgumentResolver; # add</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">$route = $matcher-&gt;match($request-&gt;getPathInfo());</span><br><span class="line">$request-&gt;attributes-&gt;add($route); # add 将路由映射关系写入request对象的附加属性中。</span><br><span class="line"></span><br><span class="line">$controller = (new ControllerResolver())-&gt;getController($request); # add 处理控制器</span><br><span class="line">$arguments = (new ArgumentResolver())-&gt;getArguments($request, $controller); # add 处理方法的参数</span><br><span class="line"></span><br><span class="line">$response = call_user_func_array($controller, $arguments);</span><br><span class="line"></span><br><span class="line">$response-&gt;send();</span><br></pre></td></tr></table></figure>

<p>更新DashboardController.php代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">namespace App\Http\Controllers;</span><br><span class="line"></span><br><span class="line">use Symfony\Component\HttpFoundation\Request; # add</span><br><span class="line">use Symfony\Component\HttpFoundation\Response;# add</span><br><span class="line"></span><br><span class="line">class DashboardController&#123;</span><br><span class="line"></span><br><span class="line">    public function index(Request $request) # # add</span><br><span class="line">    &#123;   </span><br><span class="line">        $name = $request-&gt;get(&apos;name&apos;, &apos;world&apos;); # add</span><br><span class="line"></span><br><span class="line">        return new Response(&apos;Hello &apos;.$name); # add</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用http-kernel好处就是可以处理各种问题，比如Request作为参数注入。</p>
<p>访问 <a href="http://dev.phoenix.goods/dashboard?name=SexyPhoenix，" target="_blank" rel="noopener">http://dev.phoenix.goods/dashboard?name=SexyPhoenix，</a> 得到 Hello SexyPhoenix。</p>
<blockquote>
<p><a href="http://www.symfonychina.com/doc/current/components/http_kernel.html" target="_blank" rel="noopener">http-kernel组件的使用说明</a></p>
</blockquote>
<h6 id="六、分离模板（V）"><a href="#六、分离模板（V）" class="headerlink" title="六、分离模板（V）"></a>六、分离模板（V）</h6><p>现在的框架只是简单的输出字符串，在正式环境中当然不可能这么简单，要能够返回正常的HTML页面。</p>
<p>而复杂的HTML也不能放在控制器中处理，需要分离出来，单独处理。Symfony为框架同样提供了相关的组件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer require symfony/templating</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a href="http://www.symfonychina.com/doc/current/components/templating.html" target="_blank" rel="noopener">Templating组件使用说明</a></p>
</blockquote>
<p>处理框架的目录结构。</p>
<p>在phoenix项目下，创建resources/views文件夹，继续在views下创建dashboard.php文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># dashboard.php</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;meta charset=&quot;utf-8&quot;&gt;</span><br><span class="line">        &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;</span><br><span class="line">        &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot;&gt;</span><br><span class="line">        &lt;title&gt;Phoenix&lt;/title&gt;</span><br><span class="line">        &lt;style&gt;</span><br><span class="line">            html, body &#123;</span><br><span class="line">                color: #000;</span><br><span class="line">                font-family: &apos;Raleway&apos;, sans-serif;</span><br><span class="line">                font-weight: 100;</span><br><span class="line">                height: 100vh;</span><br><span class="line">                margin: 0;</span><br><span class="line">            &#125;</span><br><span class="line">        &lt;/style&gt;</span><br><span class="line">    &lt;/head&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">        &lt;div&gt;</span><br><span class="line">            &lt;h2&gt;Hello, &lt;b&gt;&lt;?php echo $name?&gt;&lt;/b&gt;&lt;/h2&gt;</span><br><span class="line">            &lt;h3&gt;your mailbox：&lt;?php echo $email?&gt;&lt;/h3&gt;</span><br><span class="line">            &lt;h3&gt;your github：&lt;?php echo $github?&gt;&lt;/h3&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>在app/Http/Controllers下创建Controller.php文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># Controller.php</span><br><span class="line"></span><br><span class="line">namespace App\Http\Controllers;</span><br><span class="line"></span><br><span class="line">use Symfony\Component\HttpFoundation\Response;</span><br><span class="line">use Symfony\Component\Templating\PhpEngine;</span><br><span class="line">use Symfony\Component\Templating\TemplateNameParser;</span><br><span class="line">use Symfony\Component\Templating\Loader\FilesystemLoader;</span><br><span class="line"></span><br><span class="line">class Controller &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * $templete 模板文件</span><br><span class="line">     * $data 数据</span><br><span class="line">     */</span><br><span class="line">    public function render($templete, array $data)</span><br><span class="line">    &#123;</span><br><span class="line">        return new Response(</span><br><span class="line">            (new PhpEngine(</span><br><span class="line">                new TemplateNameParser(), </span><br><span class="line">                new FilesystemLoader(getcwd().&apos;/resources/views/%name%&apos;)</span><br><span class="line">            ))</span><br><span class="line">            -&gt;render($templete, $data)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>改造DashboardController.php 代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">namespace App\Http\Controllers;</span><br><span class="line"></span><br><span class="line">use Symfony\Component\HttpFoundation\Request;</span><br><span class="line"></span><br><span class="line">class DashboardController extends Controller&#123; # 继承Controller</span><br><span class="line"></span><br><span class="line">    public function index(Request $request)</span><br><span class="line">    &#123;   </span><br><span class="line">        $name = $request-&gt;get(&apos;name&apos;, &apos;world&apos;);</span><br><span class="line"></span><br><span class="line">        $data = [</span><br><span class="line">            &apos;name&apos;   =&gt; $name,</span><br><span class="line">            &apos;email&apos;  =&gt; &apos;sexyphoenix@163.com&apos;,</span><br><span class="line">            &apos;github&apos; =&gt; &apos;https://github.com/SexyPhoenix&apos;</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        return $this-&gt;render(&apos;dashboard.php&apos;, $data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问 <a href="http://dev.phoenix.goods/dashboard?name=SexyPhoenix，" target="_blank" rel="noopener">http://dev.phoenix.goods/dashboard?name=SexyPhoenix，</a> 页面正常显示。</p>
<p><img src="https://img2018.cnblogs.com/blog/423266/201912/423266-20191217110058798-361085110.png" alt="9"></p>
<h6 id="七、分离模型（M）"><a href="#七、分离模型（M）" class="headerlink" title="七、分离模型（M）"></a>七、分离模型（M）</h6><p>分离完模板后，架构的数据还是在控制器中处理，同样要做分离。不过这一步，同学们可以根据自己的意愿来，比如你可以添加仓库层、服务层等。</p>
<p>这里就做简单点，在app目录下，创建Models文件夹，继续创建User.php文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"># User.php</span><br><span class="line">namespace App\Models;</span><br><span class="line"></span><br><span class="line">class User &#123;</span><br><span class="line">    </span><br><span class="line">    protected $emails = [];</span><br><span class="line"></span><br><span class="line">    protected $githubs = [];</span><br><span class="line"></span><br><span class="line">    public function getEmailByName(string $name)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;setEmails();</span><br><span class="line"></span><br><span class="line">        return array_key_exists($name, $this-&gt;emails) ? $this-&gt;emails[$name] : &apos;&apos;; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function getGithubByName($name)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;setGithubs();</span><br><span class="line"></span><br><span class="line">        return array_key_exists($name, $this-&gt;githubs) ? $this-&gt;githubs[$name] : &apos;&apos;; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function setEmails()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;emails = [</span><br><span class="line">            &apos;SexyPhoenix&apos; =&gt; &apos;sexyphoenix@163.com&apos;</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function setGithubs()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;githubs = [</span><br><span class="line">            &apos;SexyPhoenix&apos; =&gt; &apos;https://github.com/SexyPhoenix&apos;</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>更新DashboardController.php。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># DashboardController.php</span><br><span class="line">......</span><br><span class="line">use App\Models\User #add </span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">public function index(Request $request)</span><br><span class="line">&#123;</span><br><span class="line">    $name = $request-&gt;get(&apos;name&apos;, &apos;world&apos;);</span><br><span class="line"></span><br><span class="line">    $user = new User(); # add</span><br><span class="line">    $data = [</span><br><span class="line">        &apos;name&apos;   =&gt; $name,</span><br><span class="line">        &apos;email&apos;  =&gt; $user-&gt;getEmailByName($name),  # update</span><br><span class="line">        &apos;github&apos; =&gt; $user-&gt;getGithubByName($name),# update</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    return $this-&gt;render(&apos;dashboard.php&apos;, $data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问页面，正常显示。</p>
<h6 id="八、剥离核心代码"><a href="#八、剥离核心代码" class="headerlink" title="八、剥离核心代码"></a>八、剥离核心代码</h6><p>框架的基本架构已经搭建完成，但此时的核心代码都写在了index.php里面，另写项目的话，无法复用此架构，接下来剥离出核心代码。</p>
<p>在phoenix项目下创建Core文件夹，继续创建Phoenix.php文件，移入核心代码并优化。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"># Phoenix.php</span><br><span class="line"></span><br><span class="line">namespace Core; #注意此命名空间需要注册</span><br><span class="line"></span><br><span class="line">use Symfony\Component\HttpFoundation\Request;</span><br><span class="line">use Symfony\Component\HttpFoundation\Response;</span><br><span class="line">use Symfony\Component\Routing\Loader\YamlFileLoader;</span><br><span class="line">use Symfony\Component\Config\FileLocator;</span><br><span class="line">use Symfony\Component\Routing\RequestContext;</span><br><span class="line">use Symfony\Component\Routing\Matcher\UrlMatcher;</span><br><span class="line">use Symfony\Component\HttpKernel\Controller\ControllerResolver;</span><br><span class="line">use Symfony\Component\HttpKernel\Controller\ArgumentResolver;</span><br><span class="line"></span><br><span class="line">class Phoenix &#123;</span><br><span class="line"></span><br><span class="line">    public $request;</span><br><span class="line"></span><br><span class="line">    public $routeMap;</span><br><span class="line"></span><br><span class="line">    public function handle(Request $request)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;request = $request;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line"></span><br><span class="line">            //url map</span><br><span class="line">            $this-&gt;getRouteMap();</span><br><span class="line"></span><br><span class="line">            $this-&gt;setRequestRoute();</span><br><span class="line"></span><br><span class="line">            $controller = (new ControllerResolver())-&gt;getController($request);</span><br><span class="line">            $arguments = (new ArgumentResolver())-&gt;getArguments($request, $controller);</span><br><span class="line"></span><br><span class="line">            return call_user_func_array($controller, $arguments);   </span><br><span class="line"></span><br><span class="line">        &#125; catch(\Exception $e) &#123;</span><br><span class="line"></span><br><span class="line">            return new Response(&apos;File Not Found&apos;, 404);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function setRequestRoute()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;request-&gt;attributes-&gt;add($this-&gt;routeMap-&gt;match($this-&gt;request-&gt;getPathInfo()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function getRouteMap()</span><br><span class="line">    &#123;    </span><br><span class="line">        $this-&gt;routeMap = new UrlMatcher(</span><br><span class="line">            $this-&gt;getCollection(), </span><br><span class="line">            (new RequestContext())-&gt;fromRequest($this-&gt;request)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function getCollection()</span><br><span class="line">    &#123;</span><br><span class="line">        return (</span><br><span class="line">            new YamlFileLoader(</span><br><span class="line">               new FileLocator(array(getcwd()))</span><br><span class="line">            )</span><br><span class="line">        )-&gt;load(&apos;routes/web.yaml&apos;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>更新index.php代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ini_set(&apos;display_errors&apos;, 1);</span><br><span class="line">error_reporting(-1);</span><br><span class="line"></span><br><span class="line">require_once __DIR__.&apos;/vendor/autoload.php&apos;;</span><br><span class="line"></span><br><span class="line">$kernel = new Core\Phoenix();</span><br><span class="line"></span><br><span class="line">$response = $kernel-&gt;handle(</span><br><span class="line">    Symfony\Component\HttpFoundation\Request::createFromGlobals()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">$response-&gt;send();</span><br></pre></td></tr></table></figure>

<p>注册Core命名空间，打开composer.json文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># composer.json</span><br><span class="line">&quot;autoload&quot;: &#123;</span><br><span class="line">    &quot;psr-4&quot;: &#123;</span><br><span class="line">        &quot;App\\&quot;: &quot;app/&quot;,</span><br><span class="line">        &quot;Core\\&quot;: &quot;core/&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer dump-autoload # 更新命名空间</span><br></pre></td></tr></table></figure>

<p>刷新页面，显示正常。</p>
<h6 id="九、优化框架"><a href="#九、优化框架" class="headerlink" title="九、优化框架"></a>九、优化框架</h6><p>在前面用到HttpKernel组件时，为什么介绍它是框架的内核呢？</p>
<p>因为HttpKernel里面有个很重要的概念，<strong>派遣事件，给注册过的不同监听器监听</strong>。</p>
<p>是用Mediator模式设计的，这种模式带来的好处，就是使框架的扩展性得到极大的提高。</p>
<p>在请求到响应之前设计了八种钩子，方便后期扩展，详情看下面的链接。</p>
<blockquote>
<p><a href="https://github.com/symfony/symfony/blob/3.1/src/Symfony/Component/HttpKernel/KernelEvents.php" target="_blank" rel="noopener">KernelEvents钩子介绍</a></p>
</blockquote>
<p>同时，也可以用另一种监听事件的方式，通过一个event subscriber（事件订阅器），向派遣器精确通报它要订阅哪些事件。下面对路由优化时，会用到这。</p>
<blockquote>
<p><a href="http://www.symfonychina.com/doc/current/components/event_dispatcher.html" target="_blank" rel="noopener">EventDispatcher组件使用说明</a></p>
</blockquote>
<p>HttpKernel组件的功能仅止于此吗？ 当然不，<strong>它里面有一个很重要的类“HttpKernel类”，将框架的核心Core/Phoenix.php的程序都实现了</strong>。</p>
<p>只要phoenix框架核心类Phoenix继承HttpKernel，并调用它的构造方法就行了。</p>
<p>下面来改造Core/Phoenix.php代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"># Phoenix.php</span><br><span class="line">namespace Core;</span><br><span class="line"></span><br><span class="line">use Symfony\Component\HttpFoundation\RequestStack; # add</span><br><span class="line">use Symfony\Component\HttpFoundation\Request;</span><br><span class="line">use Symfony\Component\HttpFoundation\Response;</span><br><span class="line">use Symfony\Component\Routing\Loader\YamlFileLoader;</span><br><span class="line">use Symfony\Component\Config\FileLocator;</span><br><span class="line">use Symfony\Component\Routing\RequestContext;</span><br><span class="line">use Symfony\Component\Routing\Matcher\UrlMatcher;</span><br><span class="line">use Symfony\Component\EventDispatcher\EventDispatcher; # add</span><br><span class="line">use Symfony\Component\HttpKernel\HttpKernel; # add </span><br><span class="line">use Symfony\Component\HttpKernel\Controller\ControllerResolver;</span><br><span class="line">use Symfony\Component\HttpKernel\Controller\ArgumentResolver;</span><br><span class="line">use Symfony\Component\HttpKernel\EventListener\RouterListener;</span><br><span class="line"></span><br><span class="line">class Phoenix extends HttpKernel&#123; # 继承HttpKernel</span><br><span class="line"></span><br><span class="line">    public function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">        $matcher      = new UrlMatcher($this-&gt;getCollection(), new RequestContext());</span><br><span class="line">        $requestStack = new RequestStack();</span><br><span class="line"></span><br><span class="line">        $dispatcher   = new EventDispatcher();</span><br><span class="line">        $dispatcher-&gt;addSubscriber(new RouterListener($matcher,  $requestStack)); # 订阅路由</span><br><span class="line">        </span><br><span class="line">        # HttpKernel的构造函数，可以点下面的链接进去看看</span><br><span class="line">        parent::__construct(</span><br><span class="line"></span><br><span class="line">            $dispatcher,</span><br><span class="line">            new ControllerResolver(),</span><br><span class="line">            $requestStack,</span><br><span class="line">            new ArgumentResolver()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function getCollection()</span><br><span class="line">    &#123;</span><br><span class="line">        return (</span><br><span class="line">            new YamlFileLoader(</span><br><span class="line">               new FileLocator(array(getcwd()))</span><br><span class="line">            )</span><br><span class="line">        )-&gt;load(&apos;routes/web.yaml&apos;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a href="https://github.com/symfony/symfony/blob/3.1/src/Symfony/Component/HttpKernel/HttpKernel.php" target="_blank" rel="noopener">HttpKernel类</a></p>
</blockquote>
<p>index.php的代码不用变，HttpKernel类里面也有handle方法。建议同学们看看HttpKernel类的源码。</p>
<h6 id="十、依赖注入（Dependency-Injection）"><a href="#十、依赖注入（Dependency-Injection）" class="headerlink" title="十、依赖注入（Dependency Injection）"></a>十、依赖注入（Dependency Injection）</h6><p>Phoenix类继承了HttpKernel，是整个架构的核心，在框架里面定义了“路由监听”，但如果框架不仅仅要对路由进行监听，还要对response阶段进行监听呢？是不是继续修改Phoenix类呢？</p>
<p>这样的设计对于框架来说，是绝对不友好的。那有没有方法解决呢？  </p>
<p>当然有，可以通过在外面注入对象，框架通过type检测，自动引入相关对象。</p>
<p>首先下载Symfony的DependencyInjection组件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer require symfony/dependency-injection</span><br></pre></td></tr></table></figure>

<p>在core文件夹下创建container.php文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"># container.php</span><br><span class="line">namespace Core;</span><br><span class="line"></span><br><span class="line">use Symfony\Component\DependencyInjection;</span><br><span class="line">use Symfony\Component\DependencyInjection\Reference;</span><br><span class="line">use Symfony\Component\DependencyInjection\ContainerBuilder;</span><br><span class="line">use Symfony\Component\Routing\Loader\YamlFileLoader;</span><br><span class="line">use Symfony\Component\Config\FileLocator;</span><br><span class="line"></span><br><span class="line">$app = new ContainerBuilder();</span><br><span class="line">$app-&gt;register(&apos;context&apos;, &apos;Symfony\Component\Routing\RequestContext&apos;);</span><br><span class="line">$app-&gt;register(&apos;matcher&apos;, &apos;Symfony\Component\Routing\Matcher\UrlMatcher&apos;)</span><br><span class="line">    -&gt;setArguments(array(getCollection(), new Reference(&apos;context&apos;)));</span><br><span class="line"></span><br><span class="line">$app-&gt;register(&apos;request_stack&apos;, &apos;Symfony\Component\HttpFoundation\RequestStack&apos;);</span><br><span class="line">$app-&gt;register(&apos;controller_resolver&apos;, &apos;Symfony\Component\HttpKernel\Controller\ControllerResolver&apos;);</span><br><span class="line">$app-&gt;register(&apos;argument_resolver&apos;, &apos;Symfony\Component\HttpKernel\Controller\ArgumentResolver&apos;);</span><br><span class="line">    </span><br><span class="line">$app-&gt;register(&apos;listener.router&apos;, &apos;Symfony\Component\HttpKernel\EventListener\RouterListener&apos;) # 路由监听</span><br><span class="line">    -&gt;setArguments(array(new Reference(&apos;matcher&apos;), new Reference(&apos;request_stack&apos;)));</span><br><span class="line"></span><br><span class="line">$app-&gt;register(&apos;dispatcher&apos;, &apos;Symfony\Component\EventDispatcher\EventDispatcher&apos;)</span><br><span class="line">    -&gt;addMethodCall(&apos;addSubscriber&apos;, array(new Reference(&apos;listener.router&apos;)));            </span><br><span class="line"></span><br><span class="line">$app-&gt;register(&apos;phoenix&apos;, &apos;Core\Phoenix&apos;)</span><br><span class="line">-&gt;setArguments(array(</span><br><span class="line">    new Reference(&apos;dispatcher&apos;),</span><br><span class="line">    new Reference(&apos;controller_resolver&apos;),</span><br><span class="line">    new Reference(&apos;request_stack&apos;),</span><br><span class="line">    new Reference(&apos;argument_resolver&apos;),</span><br><span class="line">));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">return $app;</span><br><span class="line"></span><br><span class="line">function getCollection()</span><br><span class="line">&#123;</span><br><span class="line">    return (</span><br><span class="line">        new YamlFileLoader(</span><br><span class="line">           new FileLocator(array(getcwd()))</span><br><span class="line">        )</span><br><span class="line">    )-&gt;load(&apos;routes/web.yaml&apos;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>别名和对象一一对应，后面可以通过别名获取对象。</p>
<p>去掉core/phoenix.php里面的代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">namespace Core;</span><br><span class="line"></span><br><span class="line">use Symfony\Component\HttpKernel\HttpKernel;</span><br><span class="line"></span><br><span class="line">class Phoenix extends HttpKernel&#123;</span><br><span class="line"></span><br><span class="line">    // public function __construct()</span><br><span class="line">    // &#123;</span><br><span class="line">    //     $matcher      = new UrlMatcher($this-&gt;getCollection(), new RequestContext());</span><br><span class="line">    //     $requestStack = new RequestStack();</span><br><span class="line"></span><br><span class="line">    //     $dispatcher   = new EventDispatcher();</span><br><span class="line">    //     $dispatcher-&gt;addSubscriber(new RouterListener($matcher,  $requestStack));</span><br><span class="line"></span><br><span class="line">    //     parent::__construct(</span><br><span class="line"></span><br><span class="line">    //         $dispatcher,</span><br><span class="line">    //         new ControllerResolver(),</span><br><span class="line">    //         $requestStack,</span><br><span class="line">    //         new ArgumentResolver()</span><br><span class="line">    //     );</span><br><span class="line">    // &#125;</span><br><span class="line"></span><br><span class="line">    // public function getCollection()</span><br><span class="line">    // &#123;</span><br><span class="line">    //     return (</span><br><span class="line">    //         new YamlFileLoader(</span><br><span class="line">    //            new FileLocator(array(getcwd()))</span><br><span class="line">    //         )</span><br><span class="line">    //     )-&gt;load(&apos;routes/web.yaml&apos;);</span><br><span class="line">    // &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>更新index.php代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ini_set(&apos;display_errors&apos;, 1);</span><br><span class="line">error_reporting(-1);</span><br><span class="line"></span><br><span class="line">require_once __DIR__.&apos;/vendor/autoload.php&apos;;</span><br><span class="line"></span><br><span class="line">$app = require_once __DIR__.&apos;/core/container.php&apos;; # add </span><br><span class="line"></span><br><span class="line">$response = $app-&gt;get(&apos;phoenix&apos;) # 通过别名获取</span><br><span class="line">    -&gt;handle(</span><br><span class="line">        Symfony\Component\HttpFoundation\Request::createFromGlobals()</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">$response-&gt;send();</span><br></pre></td></tr></table></figure>

<p>访问 <a href="http://dev.phoenix.goods/dashboard?name=SexyPhoenix，" target="_blank" rel="noopener">http://dev.phoenix.goods/dashboard?name=SexyPhoenix，</a> 显示正常。</p>
<p>到这里，框架的整个基本设计就结束了，之后需要什么功能，就可以自己用composer安装组件了,composer还是很好用的。</p>
<p>同学们如果有什么疑问的，欢迎在评论一起交流，ヾ(●´∀｀●) 。</p>
<p>最后，附一份最终代码 <a href="https://github.com/SexyPhoenix/phoenix" target="_blank" rel="noopener">phoenix web 架构</a>。</p>
<blockquote>
<p><a href="http://www.symfonychina.com/doc/current/create_framework/index.html" target="_blank" rel="noopener">参考Symfony官网 - 创建你自己的框架</a></p>
</blockquote>

    </div>
    
    <div class="post-footer">
        <div>
            
            转载声明：
            商业转载请联系作者获得授权,非商业转载请注明出处 © <a href="https://sexyphoenix.github.io" target="_blank">SexyPhoenix的博客</a>
            
            
        </div>
        <div>
            
        </div>
    </div>
</article>
<div class="article-nav prev-next-wrap clearfix">
    
    
    <a href="/架构/【高可用架构】用Nginx实现负载均衡（三）/" class="next-post btn btn-default" title='【高可用架构】用Nginx实现负载均衡（三）'>
        <span class="hidden-lg">下一篇</span>
        <span class="hidden-xs">
            【高可用架构】用Nginx实现负载均衡（三）</span><i class="fa fa-angle-right fa-fw"></i>
    </a>
    
</div>

<div id="comments">
    
<link rel="stylesheet" href="https://cdn.bootcss.com/gitalk/1.4.1/gitalk.min.css">
<script src="//cdn.bootcss.com/gitalk/1.4.1/gitalk.min.js"></script>
<script src="//cdn.bootcss.com/blueimp-md5/2.9.0/js/md5.min.js"></script>
<div id="gitalk-container"></div>
<script type="text/javascript">
var gitalk = new Gitalk({
    // Gitalk配置
    language: "en",
    clientID: "9406f48c8041bdb83500",
    clientSecret: "44ad74609a5bdd6dbe8e72380db08b0e64b2a854",
    repo: "sexyphoenix.github.io",
    owner: "sexyphoenix",
    admin: ["sexyphoenix"],
    id: md5(location.pathname),
    distractionFreeMode: true
});
gitalk.render('gitalk-container');
</script>

</div>

                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">
            文章目录
        </h3>
        
        <ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#背景"><span class="toc-text">背景</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#目录"><span class="toc-text">目录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#正文"><span class="toc-text">正文</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#一、Composer运行机制"><span class="toc-text">一、Composer运行机制</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#二、框架前期准备"><span class="toc-text">二、框架前期准备</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#三、HttpFoundation组件封装Request、Response"><span class="toc-text">三、HttpFoundation组件封装Request、Response</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#四、路由处理"><span class="toc-text">四、路由处理</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#五、控制器处理相应功能（C）"><span class="toc-text">五、控制器处理相应功能（C）</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#六、分离模板（V）"><span class="toc-text">六、分离模板（V）</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#七、分离模型（M）"><span class="toc-text">七、分离模型（M）</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#八、剥离核心代码"><span class="toc-text">八、剥离核心代码</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#九、优化框架"><span class="toc-text">九、优化框架</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#十、依赖注入（Dependency-Injection）"><span class="toc-text">十、依赖注入（Dependency Injection）</span></a></li></ol></li></ol></li></ol>
        
    </div>
</aside>
                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>
<a id="back-to-top" class="icon-btn hide">
    <i class="fa fa-chevron-up"></i>
</a>
    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="busuanzi">
    
</div>
            </div>
            <div class="col-sm-12">
                <span>Copyright &copy;
                    2017
                </span> |
                <span>
                    Powered by <a href="//hexo.io" class="copyright-links" target="_blank" rel="nofollow">Hexo</a>
                </span> |
                <span>
                    Theme by <a href="//github.com/shenliyang/hexo-theme-snippet.git" class="copyright-links" target="_blank" rel="nofollow">Snippet</a>
                </span>
            </div>
        </div>
    </div>
</div>



<script src="/js/app.js?rev=@@hash"></script>
</body>
</html>